<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Best practices on batch effects correction • Canek</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Best practices on batch effects correction">
<meta property="og:description" content="Canek">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-52309538-4"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-52309538-4');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">Canek</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.2.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Best_practices_thymus.html">Best practices on batch effects correction</a>
    </li>
    <li>
      <a href="../articles/SingleCellExperiment.html">Run Canek on SingleCellExperiment objects</a>
    </li>
    <li>
      <a href="../articles/seurat.html">Run Canek on Seurat objects</a>
    </li>
    <li>
      <a href="../articles/toy_example.html">Run Canek on a toy example</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MartinLoza/Canek/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Best practices on batch effects correction</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/MartinLoza/Canek/blob/HEAD/vignettes/articles/Best_practices_thymus.Rmd" class="external-link"><code>vignettes/articles/Best_practices_thymus.Rmd</code></a></small>
      <div class="hidden name"><code>Best_practices_thymus.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="motivation-to-develop-this-vignette-">Motivation to develop this vignette.<a class="anchor" aria-label="anchor" href="#motivation-to-develop-this-vignette-"></a>
</h2>
<p>Correcting batch effects is an important step in every multi-batch
scRNA-seq data analysis of <em>biological replicates</em>, where we
would like to preserve the within-differences of batches while reducing
technical differences. We acknowledge that batch effects correction is
just a single step in a complete analysis, and we wouldn’t like to spend
so much time on it. However, we think that it is important to pay
special attention to correct batch effects because <em>an incorrect
analysis could completely change the conclusions</em> of downstream
analyses and we might end up <em>wasting a significant amount of
research-time</em>.</p>
<p>After experiencing diverse problems and difficulties correcting batch
effects, we decided to make this vignette to help you to perform this
task as smoothly as possible. Our tips to share with you are the
next:</p>
<ul>
<li>
<strong>Tip 1</strong>. Double-check the labels you use to correct
batch effects.</li>
<li>
<strong>Tip 2</strong>. Always confirm the assay used on each
step</li>
<li>
<strong>Tip 3</strong>. Pay special attention to the variable
features used to correct batch effects.</li>
<li>
<strong>Tip 4</strong>. Confirm that you are using the correct
variable features</li>
<li>
<strong>Tip 5</strong>. Confirm the number of PCs after correcting
batch effects</li>
</ul>
<p>In this vignette, we will explain further these tips with a guided
batch correction example using two <em>thymus</em> data sets from <a href="https://tabula-muris.ds.czbiohub.org/#:~:text=Tabula%20Muris%20is%20a%20compendium,from%2020%20organs%20and%20tissues." class="external-link">Tabula
Muris</a>:</p>
<ul>
<li><a href="https://figshare.com/ndownloader/files/13090580" class="external-link">droplets</a></li>
<li><a href="https://figshare.com/ndownloader/files/13092398" class="external-link">facs</a></li>
</ul>
</div>
<div class="section level2">
<h2 id="init">Init<a class="anchor" aria-label="anchor" href="#init"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://martinloza.github.io/Canek/">Canek</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat" class="external-link">Seurat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://here.r-lib.org/" class="external-link">here</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">####################</span></span>
<span><span class="co">##GLOBAL VARIABLES##</span></span>
<span><span class="co">####################</span></span>
<span></span>
<span><span class="va">myTheme</span> <span class="op">&lt;-</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>                plot.subtitle <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>                legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#########################################</span></span>
<span><span class="co">##EXTRA FUNCTIONS USED IN THIS VIGNETTE##</span></span>
<span><span class="co">#########################################</span></span>
<span></span>
<span><span class="co">##Name: MyElbowPlot</span></span>
<span><span class="co">##Input: Seurat object, number of principal components to use.</span></span>
<span><span class="co">##Output: Elbow plot showing the variance capture by the principal components.</span></span>
<span><span class="va">MyElbowPlot</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">seurat_object</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">n_components</span> <span class="op">=</span> <span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#get PCA embeddings</span></span>
<span>  <span class="va">pca_data</span> <span class="op">&lt;-</span> <span class="fu">Seurat</span><span class="fu">::</span><span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/Embeddings.html" class="external-link">Embeddings</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">seurat_object</span>, <span class="st">"pca"</span><span class="op">)</span> </span>
<span>  <span class="co">#calculate the variance</span></span>
<span>  <span class="va">variance</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">pca_data</span>, MARGIN <span class="op">=</span> <span class="fl">2</span>, FUN <span class="op">=</span> <span class="va">var</span><span class="op">)</span></span>
<span>  <span class="co">#create data frame to plot</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Components <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pca_data</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n_components</span><span class="op">]</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pca_data</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n_components</span><span class="op">]</span><span class="op">)</span>, Variance <span class="op">=</span> <span class="va">variance</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n_components</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="co">#plot</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Components</span>, y <span class="op">=</span> <span class="va">Variance</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">60</span>, vjust <span class="op">=</span> <span class="fl">1.0</span>, hjust<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">##Name: GetIntersectHVF</span></span>
<span><span class="co">##Input: Seurat object list, number of independent features to use.</span></span>
<span><span class="co">##Output: Features' instersection</span></span>
<span><span class="va">GetIntersectHVF</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object_ls</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">n_features</span> <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">object_ls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">object_ls</span>, FUN <span class="op">=</span> <span class="va">FindVariableFeatures</span>, nfeatures <span class="op">=</span> <span class="va">n_features</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">independent_features</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">object_ls</span>, FUN <span class="op">=</span> <span class="va">VariableFeatures</span><span class="op">)</span></span>
<span>  <span class="va">intersection_features</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span>f <span class="op">=</span> <span class="va">intersect</span>, x <span class="op">=</span> <span class="va">independent_features</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">intersection_features</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">##Name: FindIntegrationHVF</span></span>
<span><span class="co">##Input: Seurat object list, number of independent features to search within a given range</span></span>
<span><span class="co">##Output: Integration features</span></span>
<span><span class="va">FindIntegrationHVF</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object_ls</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">n_features</span> <span class="op">=</span> <span class="fl">2000</span>, </span>
<span>                              <span class="va">range</span> <span class="op">=</span> <span class="fl">500</span>, <span class="va">init_nVF</span> <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>                              <span class="va">gain</span> <span class="op">=</span> <span class="fl">0.8</span>, <span class="va">max_it</span> <span class="op">=</span> <span class="fl">100</span>, <span class="va">verbose</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Init </span></span>
<span>  <span class="va">found_HFV</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">n_independent_features</span> <span class="op">=</span> <span class="va">init_nVF</span></span>
<span>  <span class="va">it</span> <span class="op">=</span> <span class="fl">1</span></span>
<span>  </span>
<span>  <span class="co">#While the difference between the number of found VF and the objective number of VF are more or less than the fixed range</span></span>
<span>  <span class="kw">while</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">n_features</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">found_HFV</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">range</span><span class="op">)</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="co"># If we get to the maximum iterations, we stop and send an error.</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">it</span> <span class="op">&gt;</span> <span class="va">max_it</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span>call. <span class="op">=</span> <span class="cn">TRUE</span>, <span class="st">"Error. The desired number of VF cannot be fulfilled within the maximum number of iterations. Try to reduce the number of n_features or to increase the gain of the search algorithm."</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="co">#Get the HVF as the intersection of independent HVF among batches</span></span>
<span>    <span class="va">found_HFV</span> <span class="op">&lt;-</span> <span class="fu">GetIntersectHVF</span><span class="op">(</span>object_ls <span class="op">=</span> <span class="va">object_ls</span>, n_features <span class="op">=</span> <span class="va">n_independent_features</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">#Update the new number of independent variable features</span></span>
<span>    <span class="va">n_independent_features</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">n_independent_features</span> <span class="op">+</span> <span class="va">gain</span><span class="op">*</span><span class="op">(</span><span class="va">n_features</span> <span class="op">+</span> <span class="va">range</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">found_HFV</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                                    digits <span class="op">=</span> <span class="op">-</span><span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="co">#Update the iteration</span></span>
<span>    <span class="va">it</span> <span class="op">&lt;-</span>  <span class="va">it</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co">#If verbose, print general information of the HVF</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">verbose</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Number of independent VF: "</span>, <span class="va">n_independent_features</span>, <span class="st">"\nNumber of VF after intersection: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">found_HFV</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">found_HFV</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="load-seurat-objects">Load seurat objects<a class="anchor" aria-label="anchor" href="#load-seurat-objects"></a>
</h2>
<p>Let’s load the two data sets using their URLs. Alternatively, you can
first download the data sets and load them from your <em>Downloads</em>
folder.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">thymus_ls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load the droplets data set</span></span>
<span><span class="co">#load(here("~/Downloads/droplet_Thymus_seurat_tiss.Robj"))</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">url</a></span><span class="op">(</span><span class="st">"https://figshare.com/ndownloader/files/13090580"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">thymus_ls</span><span class="op">[[</span><span class="st">"droplets"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">tiss</span></span>
<span></span>
<span><span class="co"># Load the facs data set</span></span>
<span><span class="co">#load(here("~/Downloads/facs_Thymus_seurat_tiss.Robj"))</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">url</a></span><span class="op">(</span><span class="st">"https://figshare.com/ndownloader/files/13092398"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">thymus_ls</span><span class="op">[[</span><span class="st">"facs"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">tiss</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">tiss</span><span class="op">)</span></span></code></pre></div>
<p>The data sets downloaded from Tabula Muris are Seurat objects, but
they are in an old format. Then, we need to update them using the
<code>UpdateSeuratObject</code> function.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">thymus_ls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">thymus_ls</span>, FUN <span class="op">=</span> <span class="fu">Seurat</span><span class="fu">::</span><span class="va"><a href="https://mojaveazure.github.io/seurat-object/reference/UpdateSeuratObject.html" class="external-link">UpdateSeuratObject</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="tip-1--double-check-the-label-you-will-use-to-correct-batch-effects-">Tip 1. Double-check the label you will use to correct batch
effects.<a class="anchor" aria-label="anchor" href="#tip-1--double-check-the-label-you-will-use-to-correct-batch-effects-"></a>
</h2>
<p>All batch effect correction methods require a batch
<code>label</code> to distinguish data sets. In this case, because the
data sets were prepared using different technologies (droplets and
facs), we would like to correct the technical differences related to
<em>technology</em>. If your data sets were prepared with the same
technology but sequenced in different samples, you might like to correct
the differences related to <em>samples</em>. It would be the same for
<em>biological</em> or <em>technical</em> replicates, you might like to
correct technical differences using the <em>replicate</em> label.</p>
<p>As we said before, in this example we would like to reduce the
technical differences between the technologies used to prepare the
cells. Because we don’t have a common label related to the technology,
let’s create one for each data set.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">thymus_ls</span><span class="op">$</span><span class="va">droplets</span><span class="op">[[</span><span class="st">"tech"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"droplets"</span></span>
<span><span class="va">thymus_ls</span><span class="op">$</span><span class="va">facs</span><span class="op">[[</span><span class="st">"tech"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"facs"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="tip-2--always-confirm-the-assay-used-on-each-step">Tip 2. Always confirm the assay used on each step<a class="anchor" aria-label="anchor" href="#tip-2--always-confirm-the-assay-used-on-each-step"></a>
</h2>
<p>In a typical batch effect correction workflow we would be switching
between <code>assays</code> on different steps, e.g. <code>RNA</code>,
<code>integrated</code> or <code>Canek</code>, etc. Then, we would
recommend you to explicitly write the assay used on each step, so you
are sure of using the correct one.</p>
<p>On this vignette, we follow the <em>standard preprocessing</em>
workflow from <a href="https://cran.r-project.org/web/packages/Seurat/index.html" class="external-link">Seurat</a>
R package (see <em>Seurat-Guided Clustering Tutorial</em> <a href="https://satijalab.org/seurat/articles/pbmc3k_tutorial.html" class="external-link">vignette</a>)
to normalize the <code>RNA</code> assay of the batches.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">thymus_ls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">thymus_ls</span>, FUN <span class="op">=</span> <span class="fu">Seurat</span><span class="fu">::</span><span class="va"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span>, assay <span class="op">=</span> <span class="st">"RNA"</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="tip-3--pay-special-attention-to-the-variable-features-used-to-correct-batch-effects-">Tip 3. Pay special attention to the variable features used to
correct batch effects.<a class="anchor" aria-label="anchor" href="#tip-3--pay-special-attention-to-the-variable-features-used-to-correct-batch-effects-"></a>
</h2>
<p>One important step for batch correction is the selection of
<em>highly variable genes</em>, also known as <em>variable features</em>
(VF), that properly capture the heterogeneity of batches without
<em>over-fitting</em> or adding <em>noisy</em> signals. The simplest way
to do this is to obtain <em>independent</em> VFs for each batch and then
find their <em>intersection</em>. In this way, the number of independent
VFs serves as a <em>trade-off</em> between reducing or preserving the
within-batch differences. Let’s check this trade-off using UMAP
representations of the <code>uncorrected</code> data with an increasing
number of VF (1k, 5k, and 10k independent VFs).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#set the number of VFs to use</span></span>
<span><span class="va">n_VF</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">5000</span>, <span class="fl">10000</span><span class="op">)</span></span>
<span><span class="co">#get the uncorrected data</span></span>
<span><span class="va">uncorrected</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span>f <span class="op">=</span> <span class="va">merge</span>, x <span class="op">=</span> <span class="va">thymus_ls</span><span class="op">)</span></span>
<span><span class="co">#normalize the uncorrected data</span></span>
<span><span class="va">uncorrected</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">uncorrected</span>, assay <span class="op">=</span> <span class="st">"RNA"</span><span class="op">)</span></span>
<span><span class="co">#list to store the plots using different number of VFs</span></span>
<span><span class="va">plots_ls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#for each number of VFs</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">n</span> <span class="kw">in</span> <span class="va">n_VF</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Get the intersection of VF using the GetIntersectHVF. This functions returns a vector containing the names of the VFs.</span></span>
<span>  <span class="va">intersected_VFs</span> <span class="op">&lt;-</span> <span class="fu">GetIntersectHVF</span><span class="op">(</span>object_ls <span class="op">=</span> <span class="va">thymus_ls</span>, n_features <span class="op">=</span> <span class="va">n</span><span class="op">)</span></span>
<span>  <span class="co">#set the variable features</span></span>
<span>  <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/VariableFeatures.html" class="external-link">VariableFeatures</a></span><span class="op">(</span><span class="va">uncorrected</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">intersected_VFs</span></span>
<span>  <span class="co"># Scale the uncorrected data for PCA. Make sure to use the VFs found before.</span></span>
<span>  <span class="va">uncorrected</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">uncorrected</span>, features <span class="op">=</span> <span class="va">intersected_VFs</span>, assay <span class="op">=</span> <span class="st">"RNA"</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="co"># Get PCA and UMAP dimensionality reductions. Make sure to use the VFs found before. </span></span>
<span>  <span class="co">#For now let's use the first 15 PCs. This is just a common number of PCs used in scRNA-seq analyses, but feel free to use a different number.</span></span>
<span>  <span class="va">uncorrected</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html" class="external-link">RunPCA</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">uncorrected</span>, assay <span class="op">=</span> <span class="st">"RNA"</span>, features <span class="op">=</span> <span class="va">intersected_VFs</span>, npcs <span class="op">=</span> <span class="fl">15</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">uncorrected</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html" class="external-link">RunUMAP</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">uncorrected</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">15</span>, reduction <span class="op">=</span> <span class="st">"pca"</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="co"># Save the scatterplot </span></span>
<span>  <span class="va">plots_ls</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html" class="external-link">DimPlot</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">uncorrected</span>, group.by <span class="op">=</span> <span class="st">"tech"</span>, pt.size <span class="op">=</span> <span class="fl">0.1</span> <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">""</span>, subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Independent HVG: "</span>, <span class="va">n</span>, <span class="st">"\nIntersected HVG: "</span>,</span>
<span>                                          <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">intersected_VFs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Warning: The default method for RunUMAP has changed from calling Python UMAP via reticulate to the R-native UWOT using the cosine metric</span></span>
<span><span class="co">#&gt; To use Python UMAP via reticulate, set umap.method to 'umap-learn' and metric to 'correlation'</span></span>
<span><span class="co">#&gt; This message will be shown once per session</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">intersected_VFs</span>, <span class="va">n_VF</span>, <span class="va">n</span><span class="op">)</span></span></code></pre></div>
<p>Let’s check the UMAP plots using different sets of VFs.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots_ls</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="va">plots_ls</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="va">plots_ls</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>guides <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html" class="external-link">NoAxes</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="va">myTheme</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>, <span class="op">)</span></span></code></pre></div>
<p><img src="Best_practices_thymus_files/figure-html/unnamed-chunk-7-1.png" width="672" style="display: block; margin: auto;"></p>
<p>As you can observe,</p>
<ul>
<li>If we used a small number of VFs (left plot; VFs before
intersection: 1k, VFs after intersection: 206), we get subtle
differences between the data sets, but the structures of cells are not
well defined.</li>
<li>If we use a large number of VFs (right plot; VFs before
intersection: 10k, VFs after intersection: 4992), we capture a more
complex structure of the cells, but the differences between batches
increased significantly.</li>
</ul>
<p>Therefore, we would prefer to use a midpoint set of VFs that captures
the heterogeneity of cells without over-increasing the batch
differences, e.g. the UMAP in the center.</p>
<p>To ease the selection of <em>integration VFs</em>, we provide the
function <code>FindIntegrationHVF</code> to find and average the number
of intersected VFs within a given range. Let’s use this function to find
1500 (+/- 100) intersected VFs.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">integration_features</span> <span class="op">&lt;-</span> <span class="fu">FindIntegrationHVF</span><span class="op">(</span>object_ls <span class="op">=</span> <span class="va">thymus_ls</span>, n_features <span class="op">=</span> <span class="fl">1500</span>, range <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of independent VF:  4800 </span></span>
<span><span class="co">#&gt; Number of VF after intersection:  1414</span></span></code></pre></div>
<p>Let’s visualize the <em>uncorrected</em> data using the variable
features we just found.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/VariableFeatures.html" class="external-link">VariableFeatures</a></span><span class="op">(</span><span class="va">uncorrected</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">integration_features</span></span>
<span><span class="va">uncorrected</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">uncorrected</span>, assay <span class="op">=</span> <span class="st">"RNA"</span>, features <span class="op">=</span> <span class="va">integration_features</span>,verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">uncorrected</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html" class="external-link">RunPCA</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">uncorrected</span>, assay <span class="op">=</span> <span class="st">"RNA"</span>, features <span class="op">=</span> <span class="va">integration_features</span>, npcs <span class="op">=</span> <span class="fl">50</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Let’s check out the elbow plot of the PCs.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">MyElbowPlot</span><span class="op">(</span>seurat_object <span class="op">=</span> <span class="va">uncorrected</span>, n_components <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span></code></pre></div>
<p><img src="Best_practices_thymus_files/figure-html/unnamed-chunk-10-1.png" width="672" style="display: block; margin: auto;"></p>
<p>The variance stabilizes after 7 PCs. In this test, we will use 10 PCs
to calculate the UMAP visualization, but feel free to try other
numbers.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">777</span><span class="op">)</span></span>
<span><span class="va">uncorrected</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html" class="external-link">RunUMAP</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">uncorrected</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, reduction <span class="op">=</span> <span class="st">"pca"</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Let’s visualize the uncorrected data by <em>technology</em> and
<em>cell-type</em>. NOTE: Tabula Muris provide the annotated cell types
in the label <code>cell_ontology_class</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html" class="external-link">DimPlot</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">uncorrected</span>, group.by <span class="op">=</span> <span class="st">"tech"</span>, pt.size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html" class="external-link">DimPlot</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">uncorrected</span>, group.by <span class="op">=</span> <span class="st">"cell_ontology_class"</span>, pt.size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html" class="external-link">NoAxes</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="va">myTheme</span></span></code></pre></div>
<p><img src="Best_practices_thymus_files/figure-html/unnamed-chunk-12-1.png" width="672" style="display: block; margin: auto;"></p>
<p>We can observe that the technical differences between technologies
caused the <em>immature T cells</em> to cluster by technology. We would
like to correct these differences using <code>Canek</code>.</p>
</div>
<div class="section level2">
<h2 id="tip-4--confirm-that-you-are-using-the-correct-variable-features-">Tip 4. Confirm that you are using the correct variable
features.<a class="anchor" aria-label="anchor" href="#tip-4--confirm-that-you-are-using-the-correct-variable-features-"></a>
</h2>
<p>To correct batch effects, Canek accepts either a list of objects or
single objects with a <code>batch</code> identifier. Don’t forget to
pass the set of VFs we previously found.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#RunCanek in a list of SingleCellExperiment objects</span></span>
<span><span class="co">#corrected &lt;- Canek::RunCanek(x = sce, features = integration_features)</span></span>
<span><span class="co">#RunCanek in a single object with a batch identifier</span></span>
<span><span class="va">corrected</span> <span class="op">&lt;-</span> <span class="fu">Canek</span><span class="fu">::</span><span class="fu"><a href="../reference/RunCanek.html">RunCanek</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">uncorrected</span>, batches <span class="op">=</span> <span class="st">"tech"</span>, features <span class="op">=</span> <span class="va">integration_features</span><span class="op">)</span></span></code></pre></div>
<p>To perform PCA it’s important to use the
<code>corrected log counts</code>. These are saved in the assay
<code>Canek</code> in the <code>SingleCellExperiment</code> object and
can be specified by changing the <code>exprs_values</code>
parameter.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">corrected</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">corrected</span>, features <span class="op">=</span> <span class="va">integration_features</span>, assay <span class="op">=</span> <span class="st">"Canek"</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">corrected</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html" class="external-link">RunPCA</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">corrected</span>, assay <span class="op">=</span> <span class="st">"Canek"</span>, features <span class="op">=</span> <span class="va">integration_features</span>, npcs <span class="op">=</span> <span class="fl">50</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="tip-5--confirm-the-number-of-pcs-after-correcting-batch-effects-">Tip 5. Confirm the number of PCs after correcting batch
effects.<a class="anchor" aria-label="anchor" href="#tip-5--confirm-the-number-of-pcs-after-correcting-batch-effects-"></a>
</h2>
<p>Let’s check out the elbow plot after correction.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">MyElbowPlot</span><span class="op">(</span>seurat_object <span class="op">=</span> <span class="va">corrected</span>, n_components <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span></code></pre></div>
<p><img src="Best_practices_thymus_files/figure-html/unnamed-chunk-15-1.png" width="672" style="display: block; margin: auto;"></p>
<p>After correction, the elbow plot presents small changes as compared
with the one we found using the <code>uncorrected</code> data set. Then,
we will continue using 10 PCs (feel free to try other numbers).</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">777</span><span class="op">)</span></span>
<span><span class="va">corrected</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html" class="external-link">RunUMAP</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">corrected</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, reduction <span class="op">=</span> <span class="st">"pca"</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Finally, we can now visualize the <code>corrected</code> data by
<code>tech</code> and <code>cell_ontology_class</code> (cell type)
labels. We can observe that after batch correction with Canek, we
minimize the batch difference in <em>immature T cells</em>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html" class="external-link">DimPlot</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">corrected</span>, group.by <span class="op">=</span> <span class="st">"tech"</span>, pt.size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html" class="external-link">DimPlot</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">corrected</span>, group.by <span class="op">=</span> <span class="st">"cell_ontology_class"</span>, pt.size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html" class="external-link">NoAxes</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="va">myTheme</span></span></code></pre></div>
<p><img src="Best_practices_thymus_files/figure-html/unnamed-chunk-17-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="session-info">Session info<a class="anchor" aria-label="anchor" href="#session-info"></a>
</h2>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; R version 4.3.0 (2023-04-21)</span></span>
<span><span class="co">#&gt; Platform: x86_64-pc-linux-gnu (64-bit)</span></span>
<span><span class="co">#&gt; Running under: Ubuntu 22.04.2 LTS</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matrix products: default</span></span>
<span><span class="co">#&gt; BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">#&gt; LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.20.so;  LAPACK version 3.10.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; locale:</span></span>
<span><span class="co">#&gt;  [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       </span></span>
<span><span class="co">#&gt;  [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   </span></span>
<span><span class="co">#&gt;  [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          </span></span>
<span><span class="co">#&gt; [10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; time zone: UTC</span></span>
<span><span class="co">#&gt; tzcode source: system (glibc)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attached base packages:</span></span>
<span><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; other attached packages:</span></span>
<span><span class="co">#&gt; [1] here_1.0.1         patchwork_1.1.2    ggplot2_3.4.2      SeuratObject_4.1.3</span></span>
<span><span class="co">#&gt; [5] Seurat_4.3.0       Canek_0.2.2       </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span><span class="co">#&gt;   [1] RColorBrewer_1.1-3     jsonlite_1.8.4         magrittr_2.0.3        </span></span>
<span><span class="co">#&gt;   [4] spatstat.utils_3.0-3   modeltools_0.2-23      farver_2.1.1          </span></span>
<span><span class="co">#&gt;   [7] rmarkdown_2.21         fs_1.6.2               ragg_1.2.5            </span></span>
<span><span class="co">#&gt;  [10] vctrs_0.6.2            ROCR_1.0-11            memoise_2.0.1         </span></span>
<span><span class="co">#&gt;  [13] spatstat.explore_3.2-1 htmltools_0.5.5        BiocNeighbors_1.18.0  </span></span>
<span><span class="co">#&gt;  [16] sass_0.4.6             sctransform_0.3.5      parallelly_1.35.0     </span></span>
<span><span class="co">#&gt;  [19] KernSmooth_2.23-20     bslib_0.4.2            htmlwidgets_1.6.2     </span></span>
<span><span class="co">#&gt;  [22] desc_1.4.2             ica_1.0-3              plyr_1.8.8            </span></span>
<span><span class="co">#&gt;  [25] plotly_4.10.1          zoo_1.8-12             cachem_1.0.8          </span></span>
<span><span class="co">#&gt;  [28] igraph_1.4.3           mime_0.12              lifecycle_1.0.3       </span></span>
<span><span class="co">#&gt;  [31] pkgconfig_2.0.3        Matrix_1.5-4           R6_2.5.1              </span></span>
<span><span class="co">#&gt;  [34] fastmap_1.1.1          fitdistrplus_1.1-11    future_1.32.0         </span></span>
<span><span class="co">#&gt;  [37] shiny_1.7.4            digest_0.6.31          colorspace_2.1-0      </span></span>
<span><span class="co">#&gt;  [40] S4Vectors_0.38.1       numbers_0.8-5          rprojroot_2.0.3       </span></span>
<span><span class="co">#&gt;  [43] tensor_1.5             irlba_2.3.5.1          textshaping_0.3.6     </span></span>
<span><span class="co">#&gt;  [46] labeling_0.4.2         progressr_0.13.0       fansi_1.0.4           </span></span>
<span><span class="co">#&gt;  [49] spatstat.sparse_3.0-1  httr_1.4.6             polyclip_1.10-4       </span></span>
<span><span class="co">#&gt;  [52] abind_1.4-5            compiler_4.3.0         withr_2.5.0           </span></span>
<span><span class="co">#&gt;  [55] BiocParallel_1.34.2    highr_0.10             MASS_7.3-58.4         </span></span>
<span><span class="co">#&gt;  [58] bluster_1.10.0         tools_4.3.0            lmtest_0.9-40         </span></span>
<span><span class="co">#&gt;  [61] prabclus_2.3-2         httpuv_1.6.11          future.apply_1.11.0   </span></span>
<span><span class="co">#&gt;  [64] goftest_1.2-3          nnet_7.3-18            glue_1.6.2            </span></span>
<span><span class="co">#&gt;  [67] nlme_3.1-162           promises_1.2.0.1       grid_4.3.0            </span></span>
<span><span class="co">#&gt;  [70] Rtsne_0.16             cluster_2.1.4          reshape2_1.4.4        </span></span>
<span><span class="co">#&gt;  [73] generics_0.1.3         gtable_0.3.3           spatstat.data_3.0-1   </span></span>
<span><span class="co">#&gt;  [76] class_7.3-21           tidyr_1.3.0            data.table_1.14.8     </span></span>
<span><span class="co">#&gt;  [79] sp_1.6-0               utf8_1.2.3             flexmix_2.3-19        </span></span>
<span><span class="co">#&gt;  [82] BiocGenerics_0.46.0    spatstat.geom_3.2-1    RcppAnnoy_0.0.20      </span></span>
<span><span class="co">#&gt;  [85] ggrepel_0.9.3          RANN_2.6.1             pillar_1.9.0          </span></span>
<span><span class="co">#&gt;  [88] stringr_1.5.0          later_1.3.1            robustbase_0.95-1     </span></span>
<span><span class="co">#&gt;  [91] splines_4.3.0          dplyr_1.1.2            lattice_0.21-8        </span></span>
<span><span class="co">#&gt;  [94] deldir_1.0-9           survival_3.5-5         FNN_1.1.3.2           </span></span>
<span><span class="co">#&gt;  [97] tidyselect_1.2.0       miniUI_0.1.1.1         pbapply_1.7-0         </span></span>
<span><span class="co">#&gt; [100] knitr_1.42             gridExtra_2.3          scattermore_1.1       </span></span>
<span><span class="co">#&gt; [103] stats4_4.3.0           xfun_0.39              diptest_0.76-0        </span></span>
<span><span class="co">#&gt; [106] matrixStats_0.63.0     DEoptimR_1.0-13        stringi_1.7.12        </span></span>
<span><span class="co">#&gt; [109] lazyeval_0.2.2         yaml_2.3.7             evaluate_0.21         </span></span>
<span><span class="co">#&gt; [112] codetools_0.2-19       kernlab_0.9-32         tibble_3.2.1          </span></span>
<span><span class="co">#&gt; [115] cli_3.6.1              uwot_0.1.14            xtable_1.8-4          </span></span>
<span><span class="co">#&gt; [118] reticulate_1.28        systemfonts_1.0.4      munsell_0.5.0         </span></span>
<span><span class="co">#&gt; [121] jquerylib_0.1.4        Rcpp_1.0.10            spatstat.random_3.1-5 </span></span>
<span><span class="co">#&gt; [124] globals_0.16.2         png_0.1-8              parallel_4.3.0        </span></span>
<span><span class="co">#&gt; [127] ellipsis_0.3.2         pkgdown_2.0.7          mclust_6.0.0          </span></span>
<span><span class="co">#&gt; [130] listenv_0.9.0          viridisLite_0.4.2      scales_1.2.1          </span></span>
<span><span class="co">#&gt; [133] ggridges_0.5.4         leiden_0.4.3           purrr_1.0.1           </span></span>
<span><span class="co">#&gt; [136] fpc_2.2-10             rlang_1.1.1            cowplot_1.1.1</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Martin Loza, Diego Diez.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
